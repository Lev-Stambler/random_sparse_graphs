\newcommand{\labelFunc}{\phi}
\newcommand{\imageFn}{\text{Image}}
\newcommand{\pathSuffix}{\text{Suff}}
\newcommand{\pathSet}{\mathcal{P}}
\newcommand{\obfFN}{\mathcal{O}}
\newcommand{\circMid}{C^{\text{Mid}}}

\section{Using Weak Extractible Obfuscation}

\subsection{Graph Randomized Traversal}
Say that we have a sparse, potentially exponentially sized, graph $\graph = (\verts, \edges)$
and $\forall v \in \verts, \deg(v) = d$. Moreover, if the graph is a DAG, for simplicity,
assume that for all $v$, 
$$
\deg^{-1}(v) = \big|\set{u \in V \mid \exists j \in [d], \Gamma(u)_j = v}\big| \leq d.
$$
In words, there are at most $d$ edges into a vertex. As a note, our construction just requires
that $\deg^{-1}(\cdot) = O(1)$ but for the sake of simplicity we fix $\deg^{-1}(\cdot) \leq d$.

We also require that $\graph$ is equipped with a neighbor function, $\Gamma$, which can be computed in polynomial time.
% (TODO: padding).
We define a randomized and keyed labelling function $\phi: \binSet^\lambda \times \verts \rightarrow \binSet^{\poly(\lambda)}$ 
such that given, $\phi(K, v_0)$ for root $v_0$, an adversary, $\advers$, which does not know a path from $v_0$ to $v$,
\begin{equation}
	\label{eq:guessPhi}
	\Pr[\advers(\mathcal{O}(\circNeigb), v_0, v, \labelFunc(K, v_0)) = \labelFunc(K, v)] \leq \epsilon
\end{equation}
for function $\circNeigb$ where $\circNeigb(\labelFunc(K, u)) = \labelFunc(K, \Gamma(u)_1), \dots, \labelFunc(K, \Gamma(u)_d)$
if $\Gamma(u) \neq \emptyset$ and otherwise $\Gamma(u)$ returns a $\bot$ string;
and, $\mathcal{O}$ represents an indistinguishable obfuscator.
We fix $\epsilon \leq \negl(\lambda)$.

\subsection{Instantiation}
We define 
\begin{equation*}
	\labelFunc(K, v) = F(K, v).
\end{equation*}

We can now define $\circNeigb$:
\begin{algorithm}[H]
	\caption{
		The circuit for the neighbor function, $\circNeigb$.
	}
	\begin{algorithmic}[1]
		\Function{$\circNeigb$}{$X, v$}
			\If{$f(X) \neq f(F(K, v))$}
				\State \Return $\bot$
			\EndIf
		 	\If{$\Gamma(v) = \emptyset$}
				\State \Return $\bot$
			\EndIf
			\State $u_1, \dots u_d = \Gamma(v)$
			\State \Return $F(K, u_1), F(K, u_2), \dots, F(K, u_d)$
		\EndFunction
	\end{algorithmic}
	\label{alg:neighb}
\end{algorithm}

We are going to show that \cref{eq:guessPhi} holds by first showing that
the non-existence of an extractor to find a path from $v_0$ to $v$ implies that $\advers$
necessarily does not know $\phi(K, c)$ for a $c \in C_V \subset V$ where the vertices in $C_V$ border 
a graph cut which separates $v_0$ and $v$. Then, we inductively build up a series of games to show that
$\advers$ cannot learn \emph{any} $\phi(K, v)$ for $v \in V_1$ where $V_1$ are the vertices on the right-hand side of the cut.

% TODO: define P way above
\begin{lemma}[Base Case Game]
	\label{lemma:cutBaseCase}
	Assuming that there is no extractor $E$ such that $\Pr[E(\Gamma, v_0, v) = P] \geq \frac{1}{p(\lambda)}$
	where $P \in \pathSet$, then for any PPT $\advers$, there exists some graph cut 
	$C_E \subset E$ which separates $v_0$ and $v$ and a set $C_V$ such that
	\begin{equation}
		\label{eq:cutLabel}
		\Pr[\advers(\obfFN(\circNeigb), v_0, v, \phi(K, v_0)) \in \phi(K, C_V)] \leq \negl(\lambda).
	\end{equation}
		We define $C_V \subset V$ to be
	\begin{equation*}
		\set{ u \mid (w, u) \in C_E \text{ and } u \text { on the side of } v} \bigcup \set{ v \mid (w, u) \in C_E \text{ and } u \text { on the side of } v}.
	\end{equation*}
	In words, $C_V$ are the vertices just adjacent to the cut and on the same side as $v$.
	\begin{proof}
		We will show that if $\advers$ can break \cref{eq:cutLabel}, then we can construct an extractor,
		$E$, which finds a path from $v_0$ to $v$ with non-negligible probability.

		Assume that for every possible cut, $\advers$ is able to produce a single label in this cut for a vertex $w$.
		Then, we note that there must be at least 1 path from $v_0$ to $w$ and $v$ as otherwise, $w$ would not be in the cut.
		Moreover, we note that $\advers$ must be able to produce a label for all vertices on at least one path
		from $v_0$ to $w$ as otherwise, we can change the cut to include the edges between where
		$\advers$ is able to produce a label and not able to produce a label. Using the same argument,
		we can show that $\advers$ must be able to produce all labels on a path from $w$ to $v$.

		Note that $\advers$ is not given the specific cut $C_E$ but rather $C_E$ is chosen based off of the adversary.
		So, we can build an extractor to do the following:
		% TODO: is this selective security?????
		\begin{enumerate}
			\item Create an iO obfuscated circuit with a random key, $K'$, for $\circNeigb$ and create circuit $\obfFN(\circNeigb)$
			as well as $\phi(K', v_0)$
			\item Run $\advers(\obfFN(\circNeigb), v_0, v, \phi(K', v_0))$ to get all labels $\phi(K', v_0), \dots \phi(K', v)$
			for some path from $v_0$ to $v$.
			\item Recreate the path from $v_0$ to $v$ via checking which vertex matches to adjacent labels in the path:
			% TODO: this assumes no cycles!!!
			I.e.\ starting with $\ell = 0$, we can learn the $\ell + 1$ vertex via finding $j \in [d]$ such that
			$\circNeigb(\phi(K', v_\ell), v_\ell)_j \in \set{\phi(K', v_0), \dots, \phi(K', v)}$
			 and then setting $v_{\ell + 1} = \Gamma(v_\ell)_j$.
		\end{enumerate}
	\end{proof}
\end{lemma}

We can look at \cref{lemma:cutBaseCase} as a ``base case'' of sorts. We now inductively build up a series of games
such that $\advers$ cannot find any label in $V_1$ where $V_1$ are the vertices on side of the cut (as defined in \cref{lemma:cutBaseCase})
which contain $v$.

\begin{lemma}[Inductive Game Hypothesis]
	Let $H \subset V$ be a ``hard'' set of vertices such that $\advers$ cannot, with non-negligible probability, produce 
	$\phi(K, h)$ where $h \in H$. Note that the base case has $H = C_V$. Then, 
	for any $v \notin H$ and $w \in \Gamma(h)$ for all $h \in H$, we have that
	\begin{equation*}
		% TODO: change all to just <
		% TODO: maybe we nee to fix \eps
		\Pr[\advers(\obfFN(\circNeigb), v_0, w, \phi(K, v_0)) = \phi(K, w)] < \negl(\lambda).
	\end{equation*}
	\begin{proof}
		We are going to use a series of indistinguishable hybrids along with the circuit defined in \ref{alg:neighbHyb1} to show the above
		\begin{itemize}
			\item $\Hyb_0$: In the first hybrid, the following game is played
				\begin{enumerate}
					\item $K \gets \binSet^{\lambda'}$ and $\phi(K, v_0) = (F(K, v_0), v)$ where $K$ is some fixed secret drawn from a random distribution
					\item The challenger generates $\mathcal{O}(\circNeigb)$ and gives the program to $\advers$
					\item The challenger gives the adversary $w^*$ in plaintext.
					\item $\advers$ outputs guess $g$ and wins if $g = \phi(K, w^*)$ %hmmm... do we give w?
				\end{enumerate}
			
			\item $\Hyb_1$: We replace $\circNeigb$ with $\circNeigb^{w^*}$ as defined in \ref{alg:neighbHyb1}.
			Fix the constant $z^* = f(F(K, w^*))$
			% and $y^*_1 = f(F(K, \Gamma(w^*)_1)), \dots, y^*_d = f(F(K, \Gamma(w^*)_d))$.
			\item $\Hyb_{2, 1}$
			We replace \cref{alg:neighbHyb1} with \cref{alg:neighbHyb2} where we 
			set $Y^* = (1, y)$ such that $\Gamma(y)_1 = w^*$. So then, we have that
			have $F(K, \Gamma(y)_1) = \bot$
			\item $\Hyb_{2, j}$ for $j \in 2, \dots, \deg^{-1}(w^*)$
			We replace $Y^*$ with $Y^* \cup (j, y)$ such that $\Gamma(y)_j = w^*$.
			Note after the last of these hybrids, we have that $F(K, w^*)$ is always set to $\bot$.
			\item $\Hyb_3$: Set $z^* = f(t)$ where $t$ is chosen at random %TODO: specify field size
		\end{itemize}
		Finally, we can note that if $\Hyb_0 \compInd \Hyb_2$,
		\begin{equation*}
			\Pr[\advers(\circNeigb, v_0, w, \phi(K, v_0)) = \phi(K, w)] 
			\compInd
			\Pr[\advers(\circNeigb^*, v_0, w, \phi(K, v_0)) = \phi(K, w)]
		\end{equation*}
		where $z^*$ in $\circNeigb^*$	is the image on a OWF of a randomly chosen point.
		As we will show in \cref{lemma:hybA}, \cref{lemma:hybB}, and \cref{lemma:hybC},
		an adversaries advantage between games in $\Hyb_0$ and $\Hyb_3$ is at most $\epsilon / 2$.
		Thus, if $\advers$ can produce $\phi(K, v) = (\sigma_v, v)$ with advantage $\epsilon / 2$
		in $\Hyb_3$, then $\advers$
		can find a pre-image for $z*$ under $f$ with non-negligible probability and thus break the security of a one way function.
		We then have that the advantage of the adversary in $\Hyb_0$ cannot be more than $\epsilon$.
	\end{proof}
\end{lemma}

% Hmmmmm we can still not fully use eO correctly, there may be more than one
% input which messes us up...
% I guess that we can simply **require** each vertex to have a polynomial number of inputs...
% Hmmm... also still need to see if DAGs are required!
% Maybe to remove DAG we have two functions with different proofs?: 1 on the way forward
% and 1 on the way "backwards"
% TODO: for now j assume DAG with limited (poly) number of inputs

\begin{lemma}
	\label{lemma:hybA}
	% TODO: workout
	$\Hyb_0$ and $\Hyb_1$ are distinguishable with advantage at most $\epsilon / 8$.
	\begin{proof}
		Note that for all inputs $(z, v)$ to $\circNeigb$ as defined in \cref{alg:neighb} and \cref{alg:neighbHyb1}
		are equivalent and thus indistinguishable by the definition of indistinguishable obfuscation.
		So, if $\eps \in \poly(\lambda)$, then an adversary cannot distinguish the hybrids with probability more than $\epsilon / 8$.
	\end{proof}
\end{lemma}

\begin{lemma}
	\label{lemma:hybB}
	Each hybrid from $\Hyb_1$ to $\Hyb_{2, 1}$ and $\Hyb_{2, j - 1}$ to $\Hyb_{2, j}$ for $j \in 2, \dots, \deg^{-1}(w^*)$
	is distinguishable with advantage at most $\epsilon / (8d)$. Thus, $\Hyb_1$ and $\Hyb_{2, \deg^{-1}(w^*)}$ are distinguishable with advantage at most $\epsilon / 8$.
	\begin{proof}
		This proof will follow very closely the simple case of weak extractible obfuscation	as defined in (TODO: cite).
		The key idea is that if a hybrid is distinguishable with advantage more than $\epsilon / (8d)$, then
		$\advers$ can produce a label $\phi(K, h)$ for $h \in H$.

		First, assume towards contradiction that there exists an adversary $\advers$ that can distinguish two consecutive hybrids
		with polynomial advantage $\epsilon' > \epsilon / 8d$.
		Following the proof sketch in (TODO: cite), say that the input size to $\circNeigb$ is $n$.
		Also, let $C_0$ be the circuit from the first hybrid and $C_1$ the one from the second.
		Let $\circMid_i$ be a circuit such that $\circMid_i(X) = C_0(X)$ if $X_i = 0$ and $\circMid_i(X) = C_1(X)$ if $X_i = 1$.
		Note that $C_0$ and $C_1$ differs on at most 1 input (which is the appended vertex $y$ to $Y^*$);
		call this input $\alpha$.
		Then, $\circMid_i = C_0$ if $\alpha_i = 0$ and $\circMid_i = C_1$ if $\alpha_i = 1$.
		So, if we build an adversary $\adversB$ to tell if $\circMid_i = C_0$ or $C_1$ with probability $\gamma$,
		we have that $\adversB$ can tell if $\alpha_i$ is $0$ or $1$ with probability $\gamma$.
		Thus, $\adversB$ can reconstruct $\alpha$ with probability at least $\gamma^n$.
		Note that this implies that $\adversB$ can learn $\phi(K, y)$ where $y \in H$ by construction
		and thus gives our desired contradiction.
		So now, we just need to build $\adversB$ to tell if $\circMid_i = C_0$ or $C_1$ with probability $\gamma^n \geq \frac{\epsilon}{8d}$.

		Then, $\advers$ can distinguish between $C^M$ via the following:
		\begin{enumerate}
			\item Run $I$ iterations of the following experiment to estimate advantage $\epsilon'_b$ for $b \in \set{0, 1}$
				\begin{enumerate}
					\item Sample a random obfuscation of $C_b$ via re-obfuscating the existing $C_b$
					\item Sample a random obfuscation of $\circMid_i$ via re-obfuscating $\circMid_i$
					\item Have $\advers$ distinguish between $C_b$ and $\circMid$
					\item Output 1 if successful.
				\end{enumerate}
			Note that we can estimate $\epsilon'_b$ as the number of successful runs, which we will denote $\sum_{j \in [I]} S_{i, j}$, divided by $I$.
			\item If $\epsilon'_1 > \epsilon'_0$, then $\circMid = C_0$, otherwise, $\circMid = C_1$.
		\end{enumerate}
		WLOG, say that $\circMid = C_0$, then
		\begin{align*}
			\Pr[\epsilon'_1 > \epsilon'_0] &= \Pr[\sum_{j} S_{1, j} > \sum_{j} S_{0, j}]\\
			&\geq \Pr\left[\sum_{j} S_{1, j} > \frac{I\epsilon'}{2}\right] \cdot \Pr\left[\sum_{j} S_{0, j} < \frac{I\epsilon'}{2}\right].
		\end{align*}
		We then have that
		\begin{align*}
			\Pr\left[\sum_{j} S_{1, j} > I\epsilon' \cdot \half\right] \geq 1 - \exp\left( -\frac{I\eps'}{2^2 \cdot 3}\right) =  1 - \exp\left( -\frac{I\eps'}{96}\right). \tag{by the Chernoff bound}
		\end{align*}
		And, if iO distinguishing advantage is at most $\alpha$ and $\delta = \frac{\eps'}{2\alpha} - 1$
		\begin{align*}
			\Pr\left[\sum_{j} S_{0, j} < \frac{I\epsilon'}{2}\right] &= 1 - Pr\left[\sum_{j} S_{0, j} \geq  (1 + \delta) I\alpha\right]
			\geq 1 - \exp\left( - I \alpha \left(\frac{\eps'}{2\alpha} - 1\right)^2 \cdot \frac{1}{3} \right) \tag{by the Chernoff bound}\\
			&\geq 1 - \exp\left( - \frac{I\eps'^2}{12\alpha}\right) \geq 1 - \exp\left(-\frac{I\eps'}{12}\right). \tag{as $\eps' > \alpha$}.
		\end{align*}
		So we finally have that
		\begin{equation}
			\Pr[\eps'_1 > \eps'_0] \geq 1 - \exp\left(-\frac{I\eps'}{12}\right) - \exp\left( -\frac{I\eps'}{96}\right) \geq 1 - 2\exp\left( -\frac{I\eps'}{96}\right). 
		\end{equation}
		
		Setting $I > \frac{\ln2 \cdot 96\left(\ln n - \ln \left(1 - \frac{\eps}{8d}\right)\right)}{\eps'}$, we have that
		\begin{align*}
			\left(\Pr[\eps'_1 > \eps'_0]\right)^n &\geq \left(1 - 2\exp\left( -\frac{I\eps'}{96}\right)\right)^n \\
			&\geq 1 - 2n \cdot \exp\left( -\frac{I\eps'}{96}\right) = 1 - 2n \cdot \exp\left( -\left(\ln n + \ln\left(1 - \frac{\eps}{8d}\right)\right) \cdot 2\right)\\
			&= 1 - \left(1 - \frac{\eps}{8d}\right) = \frac{\eps}{8d}
		\end{align*}
		as desired.
	\end{proof}
	
\end{lemma}

\begin{lemma}
	\label{lemma:hybC}
	AAA
\end{lemma}

\begin{algorithm}[H]
	\caption{
		Circuit for the neighbor function, $\circNeigb$ with punctured PRF key
		$K(\set{w^*})$ and constant $w^*, z^*$%, y^*_1, y^*_2, \dots, y^*_d$
	}
	\begin{algorithmic}[1]
		\Function{$\circNeigb$}{$X, v$}
			\If{$v \neq w$ and $f(X) \neq f(F(K, v))$}
				\State \Return $\bot$
			\EndIf
			\If{$v = w$ and $f(X) \neq z^*$}
				\State \Return $\bot$ 
			\EndIf
		 	\If{$\Gamma(v) = \emptyset$}
				\State \Return $\bot$
			\EndIf
			% \If{$v = w$}
			% 	\State \Return $z^*_1, z^*_2, \dots, z^*_d$
			% \EndIf
			\State $u_1, \dots u_d = \Gamma(v)$
			\State \Return $F(K, u_1), F(K, u_2), \dots, F(K, u_d)$
		\EndFunction
	\end{algorithmic}
	\label{alg:neighbHyb1}
\end{algorithm}
% TODO: change w to w^*


\begin{algorithm}[H]
	\caption{
		Circuit for the neighbor function, $\circNeigb$ with punctured PRF key
		$K(\set{w^*})$ and constant $w^*, Y^*, J^*, z^*$%, y^*_1, y^*_2, \dots, y^*_d$
	}
	\begin{algorithmic}[1]
		\Function{$\circNeigb$}{$X, v$}
			\If{$v \neq w$ and $f(X) \neq f(F(K, v))$}
				\State \Return $\bot$
			\EndIf
			\If{$v = w$ and $f(X) \neq z^*$}
				\State \Return $\bot$ 
			\EndIf
		 	\If{$\Gamma(v) = \emptyset$}
				\State \Return $\bot$
			\EndIf
			% \If{$v = w$}
			% 	\State \Return $z^*_1, z^*_2, \dots, z^*_d$
			% \EndIf
			\State $u_1, \dots u_d = \Gamma(v)$
			\If{$\exists j \in [d], (j^*, v^*) \in Y^*$}
			 	\State Set $F(K, u_{j^*}) = \bot$
			\EndIf
			\State \Return $F(K, u_1), F(K, u_2), \dots, F(K, u_d)$
		\EndFunction
	\end{algorithmic}
	\label{alg:neighbHyb2}
\end{algorithm}

	\begin{lemma}
		The game in $\Hyb_1 (1a)$ is indistinguishable from $\Hyb_0$.
		\begin{proof}
			As the functionality of $\circNeigb$ in $\Hyb_0$ equals that of $\Hyb_1 (1a)$,
			we have indistinguishable simply from the definition of indistinguishable obfuscation.
		\end{proof}
	\end{lemma}

	\begin{lemma}
		The game in $\Hyb_1 (1b)$ is indistinguishable from $\Hyb_1 (1a)$.
		\begin{proof}
			Here we argue that if the game in $\Hyb_1 (1b)$ is distinguishable from
			$\Hyb_1 (1a)$, then we can construct an adversary, $\adversB$, which can break the security of the PRF
			at the punctured point. 

			% TODO: wait is this trivial??? Like just use the extractor definition???
			% But then wait, something is not right here
			% Something 

			% TODO: change game
		\end{proof}
	\end{lemma}

	\begin{lemma}
		The game in $\Hyb_1 (2a)$ is indistinguishable from $\Hyb_0$ and, by the inductive hypothesis, all previous hybrids.
		\begin{proof}
			Again, we have that the circuit for $\circNeigb$ is the same in $\Hyb_0$ and $\Hyb_1 (2a)$.
			Thus, by the definition of indistinguishable obfuscation, these games are indistinguishable.
		\end{proof}
	\end{lemma}

	\begin{lemma}
		The game in $\Hyb_1 (2b)$ is indistinguishable from $\Hyb_1 (2a)$ and, by the inductive hypothesis, all previous hybrids.
		\begin{proof}
			TODO: PRF security + extractor part
		\end{proof}
	\end{lemma}

	